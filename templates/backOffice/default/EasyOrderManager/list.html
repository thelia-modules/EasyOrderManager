{extends file="admin-layout.tpl"}

{block name="check-resource"}admin.order{/block}
{block name="check-access"}view{/block}
{block name="page-title"}Gestion des commandes avec EasyOrderManager{/block}

{block name="after-admin-css"}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css" rel="stylesheet" />
<style>
    {literal}
    .js-list {
        width: 100% !important;
    }
    .js-animate-info-button {
        animation: AnimateInfoButton 2s infinite;
    }
    @keyframes AnimateInfoButton{
        0%{opacity: 1;}
        50%{opacity: 0;}
        100%{opacity: 1;}
    }
    {/literal}
</style>
{/block}

{block name="main-content"}
<div id="module-easy-order-manager">

    <div id="wrapper" class="container">

        <div class="row">
            <div class="col-md-12 general-block-decorator">

                <div class="row">
                    <div class="col-md-4 filter">
                        <div class="form-group">
                            <label for="js-input-search-order">Rechercher commande</label>
                            <input type="text" class="form-control js-refresh-table" data-default="" id="js-input-search-order" placeholder="Id ou référence">
                        </div>
                    </div>
                    <div class="col-md-4 filter">
                        <div class="form-group">
                            <label for="js-input-search-company">Rechercher entreprise</label>
                            <input type="text" class="form-control js-refresh-table" data-default="" id="js-input-search-company" placeholder="Nom de l'entreprise">
                        </div>
                    </div>
                    <div class="col-md-4 filter">
                        <div class="form-group">
                            <label for="js-input-search-customer">Rechercher client</label>
                            <input type="text" class="form-control js-refresh-table" data-default="" id="js-input-search-customer" placeholder="Nom, email ou tel du client">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 filter">
                        <div class="form-group">
                            <label for="js-input-status" class="control-label">
                                Etat :
                            </label>

                            <select id="js-input-status" class="form-control js-refresh-table" data-default="">
                                <option value="">Aucun etat filtré</option>

                                {loop type='order-status' name='order-status'}
                                <option value="{$ID}" >{$TITLE}</option>
                                {/loop}

                            </select>
                        </div>
                    </div>
                    <div class="col-md-6 filter">
                        <div class="form-group">
                            <label for="js-input-payment-module" class="control-label">
                                Moyen de paiement :
                            </label>

                            <select id="js-input-payment-module" class="form-control js-refresh-table" data-default="">
                                <option value="">Aucun moyen de paiement filtré</option>

                                {loop type='module' name='payment-modules' module_type=3}
                                <option value="{$ID}" >{$TITLE}</option>
                                {/loop}

                            </select>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label" for="js-input-created-at-from">
                                Création : À partir du
                            </label>

                            <div class="input-group">
                                <input type="date" id="js-input-created-at-from" class="form-control js-refresh-table" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label" for="js-input-created-at-to">
                                Jusqu'au
                            </label>

                            <div class="input-group">
                                <input type="date" id="js-input-created-at-to" class="form-control js-refresh-table" value="" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label" for="js-input-invoice-date-from">
                                Facturation : À partir du
                            </label>

                            <div class="input-group">
                                <input type="date" id="js-input-invoice-date-from" class="form-control js-refresh-table" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label" for="js-input-invoice-date-to">
                                Jusqu'au
                            </label>

                            <div class="input-group">
                                <input type="date" id="js-input-invoice-date-to" class="form-control js-refresh-table" value="" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2 filter">
                        <div class="form-group">
                            <button id="delete-selected-items" class="btn btn-danger">Supprimer les éléments sélectionnés</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    {foreach from=$template_fields item=template}
                    {include $template}
                    {/foreach}
                </div>
                <div class="row">
                    <div class="col-md-12 filter">
                        <table class="js-list table table-striped table-bordered">
                            <thead>
                            <tr>
                                {foreach from=$columnsDefinition item=definition}
                                <td>
                                    {$definition.title nofilter}
                                </td>
                                {/foreach}
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Modal Info -->
    <div class="modal fade" id="modal-info" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Informations module</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <iframe width="100%" frameborder="0" height="300" src="https://www.gilles-bourgeat.fr/thelia/module/easy-product-manager?tv={$theliaVersion}&mv={$moduleVersion}&mn={$moduleName}&lang={$app->request->getSession()->getLang()->getLocale()}">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirm Delete Selected Orders -->
    <div class="modal fade" id="modal-delete-selected" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Supprimer les commandes sélectionnées</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Êtes-vous sûr de vouloir supprimer les commandes sélectionnées ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-selected">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-order-not-paid" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Commande non payable</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>La commande ne peut pas être supprimée car elle n'est pas payée.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

</div>
{/block}

{block name="javascript-last-call"}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
{*<script src="https://cdnjs.cloudflare.com/ajax/libs/history.js/1.8/bundled/html4+html5/jquery.history.min.jss"></script>*}

<script>
    "use strict";
    (function($, $module) {
        // Ajout du bouton d'information du module
        $('#page-wrapper .page-header').append('<button class="btn btn-info js-module-easy-order-manager-info pull-right"><i class="glyphicon glyphicon-info-sign"></i></button>');

        var table = $module.find('.js-list').DataTable({
            processing: true,
            serverSide: true,
            searching: false,
            lengthChange: false,
            scrollX: true,
            order: [[1, "desc"]],
            ajax: {
                url: "{url current=true}",
                method: 'POST',
                data: function(data) {
                    // Ajouter des informations de debug
                    console.log('Fetching data with filter:', data.filter);

                    data.filter = {
                        status: $module.find('#js-input-status').val(),
                        paymentModuleId: $module.find('#js-input-payment-module').val(),
                        createdAtFrom: $module.find('#js-input-created-at-from').val(),
                        createdAtTo: $module.find('#js-input-created-at-to').val(),
                        invoiceDateFrom: $module.find('#js-input-invoice-date-from').val(),
                        invoiceDateTo: $module.find('#js-input-invoice-date-to').val(),
                        searchOrder: $module.find('#js-input-search-order').val(),
                        searchCompany: $module.find('#js-input-search-company').val(),
                        searchCustomer: $module.find('#js-input-search-customer').val(),
                    };

                    [...document.querySelectorAll(".js-filter-element")].forEach(el => {
                        data.filter[el.name] = el.value;
                    });

                    data.searchOrder = {
                        "value": $module.find('#js-input-search-order').val(),
                        regex: false
                    };

                    data.searchCompany = {
                        "value": $module.find('#js-input-search-company').val(),
                        regex: false
                    };

                    data.searchCustomer = {
                        "value": $module.find('#js-input-search-customer').val(),
                        regex: false
                    };

                    data.length = $module.find('#js-input-length').val();
                }
            },
            displayLength: 25,
            columnDefs: [
                {
                    className: "text-center",
                    targets: 0,
                    orderable: false,
                    render: function(data, type, row, meta) {
                        return '<input type="checkbox" class="select_order" data-id="' + (data ? data.order_ids : '') + '">';
                    }
                },
                {
                    className: "text-center",
                    targets: 1,
                    render: function(data, type, row, meta) {
                        if (data && data.id) {
                            return '<a href="' + data.id.href + '">' + data.id + '</a>';
                        }
                        return 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 2,
                    render: function(data, type, row, meta) {
                        if (data && data.ref) {
                            return '<a href="' + data.ref.href + '">' + data.ref + '</a>';
                        }
                        return 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 3,
                    render: function(data, type, row, meta) {
                        return data ? data : 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 4,
                    render: function(data, type, row, meta) {
                        return data ? data : 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 5,
                    render: function(data, type, row, meta) {
                        if (data && data.href) {
                            return '<a href="' + data.href + '">' + data + '</a>';
                        }
                        return 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 6,
                    render: function(data, type, row, meta) {
                        if (data && data.href) {
                            return '<a href="' + data.href + '">' + data.name + '</a>';
                        }
                        return 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 7,
                    render: function(data, type, row, meta) {
                        return data ? data : 'N/A';
                    }
                },
                {
                    className: "text-center",
                    targets: 8,
                    render: function(data, type, row, meta) {
                        if (data) {
                            return '<span class="label" style="background-color: ' + data.color + ';">' + data.name + '</span>';
                        }
                        return 'N/A';
                    }
                },
                {
                    className: "text-right",
                    targets: 9,
                    render: function(data, type, row, meta) {
                        var html = '';
                        if (data) {
                            if (data.hrefPrint) {
                                html += '<a href="' + data.hrefPrint + '" class="btn btn-default" title="Imprimer">' +
                                    '<i class="glyphicon glyphicon-print"></i>' +
                                    '</a>';
                            }
                            if (data.hrefUpdate) {
                                html += '<a href="' + data.hrefUpdate + '" class="btn btn-info" title="Modifier">' +
                                    '<i class="glyphicon glyphicon-edit"></i>' +
                                    '</a>';
                            }
                            if (!data.isCancelled) {
                                html += '<a href="#" class="btn btn-danger js-action-delete" title="Supprimer" data-id="' + data.order_id + '">' +
                                    '<i class="glyphicon glyphicon-trash"></i>' +
                                    '</a>';
                            }
                        }
                        return html;
                    }
                }
            ],
            language: {
                "sProcessing": "Traitement en cours...",
                "sSearch": "Rechercher&nbsp;:",
                "sLengthMenu": "Afficher _MENU_ &eacute;l&eacute;ments",
                "sInfo": "Affichage de l'&eacute;l&eacute;ment _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
                "sInfoEmpty": "Affichage de l'&eacute;l&eacute;ment 0 &agrave; 0 sur 0 &eacute;l&eacute;ment",
                "sInfoFiltered": "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                "sLoadingRecords": "Chargement en cours...",
                "sZeroRecords": "Aucun &eacute;l&eacute;ment &agrave; afficher",
                "sEmptyTable": "Aucune donn&eacute;e disponible dans le tableau",
                "oPaginate": {
                    "sFirst": "Premier",
                    "sPrevious": "Pr&eacute;c&eacute;dent",
                    "sNext": "Suivant",
                    "sLast": "Dernier"
                },
                "oAria": {
                    "sSortAscending": ": activer pour trier la colonne par ordre croissant",
                    "sSortDescending": ": activer pour trier la colonne par ordre d&eacute;croissant"
                }
            }
        });

        function resetPopoverPosition() {
            if (popoverPosition !== null) {
                popoverPosition.popover('destroy');
            }
        }

        var $modalDelete = $module.find('#modal-delete-selected');

        // Gestion du clic sur le bouton de suppression
        table.on('click', '.js-action-delete', function(e) {
            e.preventDefault();
            console.log('Delete button clicked');

            var orderId = $(this).data('id');
            console.log($(this).data);
            var orderStatus = $(this).data('status'); // Assurez-vous que le statut est inclus dans les données de la ligne de commande

            if (orderStatus === 1) {
                alert("Les commandes non payées ne peuvent pas être supprimées.");
                return;
            }

            // Set proper order ID in delete form
            $modalDelete.find('#cancel_order_id').val(orderId);

            $modalDelete.modal('show');
        });

// Gestion du formulaire de suppression
        $modalDelete.on('submit', 'form', function(e) {
            e.preventDefault();
            console.log('Form submitted for deletion');

            var selectedIds = [];
            $('.select_order:checked').each(function() {
                var orderId = $(this).data('id');
                var orderStatus = $(this).data('status'); // Assurez-vous que le statut est inclus dans les données de la ligne de commande

                if (orderStatus === 1) {
                    alert("Les commandes non payées ne peuvent pas être supprimées.");
                    return;
                }

                selectedIds.push(orderId);
            });

            if (selectedIds.length > 0) {
                console.log('Selected order IDs:', selectedIds);

                $.ajax({
                    url: "/admin/easy-order-manager/delete-selected",
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ order_ids: selectedIds }),
                    success: function(response) {
                        console.log('Deletion successful, response:', response);
                        table.ajax.reload(null, false);

                        setTimeout(function() {
                            $modalDelete.modal('hide');
                        }, 200);
                    },
                    error: function(xhr, status, error) {
                        console.log('Deletion failed, error:', error);
                    }
                });
            } else {
                console.log('No orders selected for deletion');
            }
        });

        $(document).ready(function() {
            // Fonction pour gérer le clic sur le bouton "select-all"
            $('#select-all').on('click', function() {
                var rows = $('.js-list').DataTable().rows({ 'search': 'applied' }).nodes();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
            });

            // Gestion de la suppression des éléments sélectionnés
            $('#delete-selected-items').on('click', function() {
                $('#modal-delete-selected').modal('show');
            });

            $('#confirm-delete-selected').on('click', function() {
                var selectedIds = [];
                var hasCancelledOrder = false;

                $('.select_order:checked').each(function() {
                    var orderId = $(this).data('id');
                    var orderStatus = $(this).data('status');

                    if (orderStatus === 5) {
                        hasCancelledOrder = true;
                    } else {
                        selectedIds.push(orderId);
                    }
                });

                if (hasCancelledOrder) {
                    alert('Les commandes annulées ne peuvent pas être supprimées.');
                    return;
                }

                if (selectedIds.length > 0) {
                    console.log('Selected order IDs for bulk deletion:', selectedIds);

                    $.ajax({
                        url: "/admin/easy-order-manager/delete-selected",
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ order_ids: selectedIds }),
                        success: function(response) {
                            var message = '';

                            if (response.deleted_orders && response.deleted_orders.length > 0) {
                                message += 'Les commandes suivantes ont été supprimées avec succès : ' + response.deleted_orders.join(', ') + '. ';
                            }

                            if (response.not_deleted_orders && response.not_deleted_orders.length > 0) {
                                message += 'Les commandes suivantes n\'ont pas pu être supprimées : ' + response.not_deleted_orders.join(', ') + '.';
                            }

                            if (response.not_deleted_orders && response.not_deleted_orders.length > 0) {
                                alert(message);
                            }

                            $('.js-list').DataTable().ajax.reload();
                            $('#select-all').prop('checked', false); // Uncheck the "select-all" checkbox
                            $('#modal-delete-selected').modal('hide');
                        },
                        error: function(xhr, status, error) {
                            alert('Une erreur est survenue : ' + error);
                        }
                    });
                } else {
                    alert('Aucune commande sélectionnée.');
                }
            });
        });

        // Modale information module
        $('.js-module-easy-order-manager-info').on('click', function() {
            $module.find('#modal-info').modal('show');
            $(this).removeClass('js-animate-info-button');
        });

        window.addEventListener("message", function(event) {
            if (event.origin === "https://www.gilles-bourgeat.fr" && event.data === 'new') {
                $(document).ready(function() {
                    $('.js-module-easy-order-manager-info').addClass('js-animate-info-button');
                });
            }
        }, false);
    }(jQuery, jQuery('#module-easy-order-manager')));
</script>
{/block}